---
title: "CPTAC all labs"
output: html_document
date: '2024-07-31'
---

```{r}
library(here)
library(msqrob2)
library(dplyr)
library(ggplot2)
library(tidyverse)
library(here)
library(BiocParallel)
library(QFeatures)

devtools::load_all(here("omicsGMF"))

```

```{r}
register(BPPARAM = MulticoreParam(workers = 1))
```

# Loading the data
```{r}
# Read the original data that is already filtered, median normalized and preprocessed in /Data/CPTAC_data.Rmd. This data has no imputed values.

sce <- readRDS(here("Data/CPTAC_data/CPTAC_sce.RDS"))


# Read the imputed intensity matrices for the different imputation methods.

sgd <- readRDS(here("Analyses/CPTAC/Output/sgd_sce.RDS"))

DAE <- read.csv(file = here("Analyses/CPTAC/Output/DAE_default_sce.csv"),
                  header = T, row.names = 1)
VAE <- read.csv(file = here("Analyses/CPTAC/Output/VAE_default_sce.csv"),
                  header = T, row.names = 1)
CF <- read.csv(file = here("Analyses/CPTAC/Output/CF_default_sce.csv"),
                  header = T, row.names = 1)
knn <- readRDS(file = here("Analyses/CPTAC/Output/knnmethod_sce.RDS"))



```

```{r}
# Define the condition and labs in colData to include as a known covariate in the msqrob2 analysis.

cond <- which(
  strsplit(colnames(sce)[[1]][1], split = "")[[1]] == "A") # find where condition is stored

colData(sce)$condition <- substr(colnames(sce), cond, cond) %>%
  unlist %>%  
  as.factor

# In this script an additional lab effect is included for lab1 as the HPLC parameters 
# were changed after the runs of condition A, B and C. Therefore, an additional
# technical effect has to be controlled for.  

colData(sce)$lab <- c(rep(rep(paste0("lab",c(4,2,3)),each=3),3),rep(rep(paste0("lab",c(1,2,3)),each=3),2)) %>% as.factor

colData(sce)$samples <- as.factor(rownames(colData(sce)))


```

# Preprocessing to get the right format

```{r}
# Impute according to the GMF model.
sce_sgd <- sce
assay(sce_sgd) <- imputeGMF(assay(sce_sgd), sgd)

rowData(sce_sgd) <- rowData(sce)[,c("Proteins","Sequence")]


```

```{r}
# Define the different summarized experiments.

sce_DAE <- sce
assay(sce_DAE) <- t(DAE)
rowData(sce_DAE) <- rowData(sce)[,c("Proteins","Sequence")]

sce_VAE <- sce
assay(sce_VAE) <- t(VAE)
rowData(sce_VAE) <- rowData(sce)[,c("Proteins","Sequence")]


sce_CF <- sce
assay(sce_CF) <- t(CF)
rowData(sce_CF) <- rowData(sce)[,c("Proteins","Sequence")]

sce_knn <- sce
assay(sce_knn) <- t(knn)
rowData(sce_knn) <- rowData(sce)[,c("Proteins","Sequence")]


```


```{r}
# Define the different QFeatures objects for the msqrob2 analysis.

# without imputed values
qf_original <- QFeatures(list("peptide" = sce), colData = colData(sce))

# imputed values according to the GMF model

qf_sce <- QFeatures(list("peptide" = sce_sgd), colData = colData(sce))

# imputed values according to the other models

qf_DAE <- QFeatures(list("peptide" = sce_DAE), colData = colData(sce))
qf_VAE <- QFeatures(list("peptide" = sce_VAE), colData = colData(sce))
qf_CF <- QFeatures(list("peptide" = sce_CF), colData = colData(sce))
qf_knn <- QFeatures(list("peptide" = sce_knn), colData = colData(sce))

```

# msqrob2 analysis

```{r}
# msqrob2 analysis to search for different abundant proteins. The model uses
# peptide intensities, but performs inference on the protein level. Here, we include
# a lab effect to control for this variation, as well as a random effect for both sample
# as protein to allow for inference on the protein level. Note that in this script
# 3 fixed effects for labs were used as the HPLC parameters were changed after some runs
# in lab 1.

# Analysis without imputed values
pe_original <- msqrobAggregate(qf_original, i = "peptide", fcol = "Proteins",
     formula = ~condition + lab + (1|samples) + (1|Sequence),
     ridge = TRUE)


# Analyses for the different imputation strategies

pe_sce <- msqrobAggregate(qf_sce, i = "peptide", fcol = "Proteins",
     formula = ~condition + lab + (1|samples) + (1|Sequence),
     ridge = TRUE)




pe_DAE <-  msqrobAggregate(qf_DAE, i = "peptide", fcol = "Proteins",
     formula = ~condition + lab + (1|samples) + (1|Sequence),
     ridge = TRUE)



pe_VAE <- msqrobAggregate(qf_VAE, i = "peptide", fcol = "Proteins",
     formula = ~condition + lab + (1|samples) + (1|Sequence),
     ridge = TRUE)



pe_CF <-  msqrobAggregate(qf_CF, i = "peptide", fcol = "Proteins",
     formula = ~condition + lab + (1|samples) + (1|Sequence),
     ridge = TRUE)


pe_knn <-  msqrobAggregate(qf_knn, i = "peptide", fcol = "Proteins",
     formula = ~condition + lab + (1|samples) + (1|Sequence),
     ridge = TRUE)

```


```{r}
# Define the different pairwise conditions that are compared. 

comparisonsRef <- paste0(paste0("ridgecondition", c("B","C","D","E")), " = 0")
comparisonsRef

comparisonsOther <- paste0(
    apply(
          combn(paste0("ridgecondition", c("B","C","D","E")), 2)[2:1, ],
          2,
          paste,
          collapse = " - ")
          , " = 0")
comparisonsOther

comparisons <- c(comparisonsRef, comparisonsOther)
comparisons

L <- makeContrast(comparisons, parameterNames = paste0("ridgecondition", c("B","C","D","E")))
L

```

```{r}
# Inference on protein level between the pairwise different conditions. 

pe_original <- hypothesisTest(object = pe_original, i = "msqrobAggregate", contrast = L)

pe_sgd <- hypothesisTest(object = pe_sce, i = "msqrobAggregate", contrast = L)

pe_DAE <- hypothesisTest(object = pe_DAE, i = "msqrobAggregate", contrast = L)
pe_VAE <- hypothesisTest(object = pe_VAE, i = "msqrobAggregate", contrast = L)
pe_CF <- hypothesisTest(object = pe_CF, i = "msqrobAggregate", contrast = L)
pe_knn <- hypothesisTest(object = pe_knn, i = "msqrobAggregate", contrast = L)

```



```{r}
# Define the known differentially abundant proteins.

rowData(pe_original[["msqrobAggregate"]])$ups <- grepl("UPS", rownames(pe_sce[["msqrobAggregate"]]))

rowData(pe_sgd[["msqrobAggregate"]])$ups <- grepl("UPS", rownames(pe_sce[["msqrobAggregate"]]))


rowData(pe_DAE[["msqrobAggregate"]])$ups <- grepl("UPS", rownames(pe_sce[["msqrobAggregate"]]))
rowData(pe_VAE[["msqrobAggregate"]])$ups <- grepl("UPS", rownames(pe_sce[["msqrobAggregate"]]))
rowData(pe_CF[["msqrobAggregate"]])$ups <- grepl("UPS", rownames(pe_sce[["msqrobAggregate"]]))
rowData(pe_knn[["msqrobAggregate"]])$ups <- grepl("UPS", rownames(pe_sce[["msqrobAggregate"]]))

```


```{r}
# Define the colours for the visualizations.

myColors <- c("#BC3C29FF", 
               "#E18727FF",
              "#EFB118FF",
              "#4269D0FF", "#A463F2FF","#20854EFF", "#9C6B4EFF", "#FFDC91FF", "#FF8AB7FF","black")
names(myColors) <- c("GMF", 
                     "GMF-batch", "GMF-batch-condition", 
                     "DAE", "CF", "VAE",
                      "KNN", "QRILC","zero",
                     "no imputation")
colScale <- scale_colour_manual(name = "Method",values = myColors)

```
# Figures TPR-FDP

```{r}
# Compute the TPR-FDP curves for each method based on the p-values that are returned
# by the msqrob2 analysis. The true positives are given by the UPS proteins. 

tprFdp <- function(pval, tp, adjPval) {
    ord <- order(pval)
    return(data.frame(
        pval = pval[ord],
        adjPval = adjPval[ord],
        tpr = cumsum(tp[ord]) / sum(tp),
        fdp = cumsum(!tp[ord]) / 1:length(tp)
    ))
}

```

```{r}

# Loop over the different pairwise comparisons to make the TPR-FDP plots.

tprFdps<-list()
tprFdpPlots <- list()

comparisons_loop <- c(paste0("ridgecondition", c("B","C","D","E")), apply(
          combn(paste0("ridgecondition", c("B","C","D","E")), 2)[2:1, ],
          2,
          paste,
          collapse = " - "))
plot_titles <- paste0(substr(comparisons_loop,15, stop = 15), " versus ", substr(comparisons_loop, 33, 33))
plot_titles[1:4] <- paste0(plot_titles[1:4], "A")

results_fdp1 <- matrix(NA, nrow = length(plot_titles), ncol = 6, 
                       dimnames = list(plot_titles, c("GMF","DAE","VAE","CF","KNN", "no imputation")))
results_fdp5 <- matrix(NA, nrow = length(plot_titles), ncol = 6, 
                       dimnames = list(plot_titles, c("GMF","DAE","VAE","CF","KNN", "no imputation")))
results_fdp10 <- matrix(NA, nrow = length(plot_titles), ncol = 6, 
                       dimnames = list(plot_titles, c("GMF","DAE","VAE","CF","KNN", "no imputation")))

for (i in comparisons_loop)
{
  # define the TPR-FDP curve for each method and for comparison i
  
tprFdporiginal <- tprFdp(rowData(pe_original[["msqrobAggregate"]])[[i]]$pval,
             rowData(pe_original[["msqrobAggregate"]])$ups,
             rowData(pe_original[["msqrobAggregate"]])[[i]]$adjPval)

tprFdpSGD <- tprFdp(
    rowData(pe_sgd[["msqrobAggregate"]])[[i]]$pval,
    rowData(pe_sgd[["msqrobAggregate"]])$ups,
    rowData(pe_sgd[["msqrobAggregate"]])[[i]]$adjPval
)



tprFdpDAE <- tprFdp(
    rowData(pe_DAE[["msqrobAggregate"]])[[i]]$pval,
    rowData(pe_DAE[["msqrobAggregate"]])$ups,
    rowData(pe_DAE[["msqrobAggregate"]])[[i]]$adjPval
)
tprFdpVAE <- tprFdp(
    rowData(pe_VAE[["msqrobAggregate"]])[[i]]$pval,
    rowData(pe_VAE[["msqrobAggregate"]])$ups,
    rowData(pe_VAE[["msqrobAggregate"]])[[i]]$adjPval
)

tprFdpCF <- tprFdp(
    rowData(pe_CF[["msqrobAggregate"]])[[i]]$pval,
    rowData(pe_CF[["msqrobAggregate"]])$ups,
    rowData(pe_CF[["msqrobAggregate"]])[[i]]$adjPval
)

tprFdpknn <- tprFdp(
    rowData(pe_knn[["msqrobAggregate"]])[[i]]$pval,
    rowData(pe_knn[["msqrobAggregate"]])$ups,
    rowData(pe_knn[["msqrobAggregate"]])[[i]]$adjPval
)

  # merge all results

hlp <- rbind(
    cbind(tprFdpSGD, method = "GMF"),
    cbind(tprFdpDAE, method = "DAE"),
    cbind(tprFdpVAE, method = "VAE"),
    cbind(tprFdpCF, method = "CF"),
    cbind(tprFdpknn, method = "KNN"),
    cbind(tprFdporiginal, method = "no imputation")
)

    hlp$method <- factor(hlp$method, levels = c("GMF","DAE","VAE","CF","KNN", "no imputation"))
    
    fdr1 <- hlp %>% group_by(method) %>% summarise(select = sum(adjPval < 0.01, na.rm = T))
    fdr5 <- hlp %>% group_by(method) %>% summarise(select = sum(adjPval < 0.05, na.rm = T))
    fdr10 <- hlp %>% group_by(method) %>% summarise(select = sum(adjPval < 0.10, na.rm = T))
    fdr1[fdr1 == 0] <- 1
    fdr5[fdr5 == 0] <- 1
    fdr10[fdr10 == 0] <- 1
    results_fdp1[plot_titles[comparisons_loop == i], ] <- hlp[c(fdr1$select + nrow(tprFdpSGD)*c(0:(length(unique(hlp$method))-1)))  , "fdp"]
    results_fdp5[plot_titles[comparisons_loop == i], ] <- hlp[c(fdr5$select + nrow(tprFdpSGD)*c(0:(length(unique(hlp$method))-1)))  , "fdp"]
    results_fdp10[plot_titles[comparisons_loop == i], ] <- hlp[c(fdr10$select + nrow(tprFdpSGD)*c(0:(length(unique(hlp$method))-1)))  , "fdp"]
      
    # Define the FDP-control when using adjusted p-values of 0.05.
    select <- hlp %>% group_by(method) %>% summarise(select = sum(adjPval < 0.05, na.rm = T))
    select[select == 0] <- 1
    
    # Make the TPR-FDP plots for comparison i

tprFdpPlots[[i]] <- hlp %>% filter(method %in% c("GMF", "DAE","VAE","CF","KNN","no imputation")) %>% 
    ggplot(aes(x = fdp, y = tpr, color = method)) +
    geom_path() + 
    geom_point(data = hlp[c(select$select + nrow(tprFdpSGD)*c(0:(length(unique(hlp$method))-1)))  , ], 
                aes(x = fdp, y = tpr, color = method), cex = 2) +
    theme_bw() + colScale + ggtitle(plot_titles[comparisons_loop == i]) + 
    xlab("FDP") + ylab("TPR") + theme(legend.position = "none", axis.title = element_text(size = 7), axis.text = element_text(size = 6), 
                                      plot.title = element_text(size=10))



}

legend <- ggpubr::get_legend(hlp %>% filter(method %in% c("GMF", "DAE","VAE","CF","KNN","no-imputation"))
                             %>% 
                               ggplot(aes(x = fdp, y = tpr, color = method)) +
                               geom_path() + 
                               geom_point(data = hlp[c(select$select + nrow(tprFdpSGD)*c(0:(length(unique(hlp$method))-1)))  , ], 
                                          aes(x = fdp, y = tpr, color = method), cex = 2) +
                               theme_bw() + colScale + ggtitle(plot_titles[comparisons_loop == i]) + 
                               xlab("FDP") + ylab("TPR") + 
                               theme(legend.position = "bottom", 
                                     legend.title = element_text(size = 7),
                                     legend.text = element_text(size = 6),
                                     legend.justification = "left", 
                                     legend.box.margin =  margin(l = 1, r = -2, unit = "cm")))



tprFdpPlots
```

```{r}
write.xlsx(results_fdp1, file= here("Figures/Supplementary_Data_FDP_control.xlsx"), 
           sheetName="DE_4labs_fdp_0.01", append=TRUE,  row.names=TRUE)
write.xlsx(results_fdp5, 
           file=here("Figures/Supplementary_Data_FDP_control.xlsx"), 
           sheetName="DE_4labs_fdp_0.05", append=TRUE, row.names=TRUE)
write.xlsx(results_fdp10, 
           file=here("Figures/Supplementary_Data_FDP_control.xlsx"), 
           sheetName="DE_4labs_fdp_0.10", append=TRUE, row.names=TRUE)
```

```{r}

full_plot_tprfdp <- gridExtra::grid.arrange(grobs = append(tprFdpPlots,
                                    list(ggpubr::as_ggplot(legend))),
                        layout_matrix = rbind(c(1:4), c(5:8), c(9:10,11,11)))

plot(full_plot_tprfdp)


saveRDS(object = append(tprFdpPlots,
                                    list(ggpubr::as_ggplot(legend))),
        file = here("Analyses/CPTAC/Output/tprfdpplots_4labs.RDS"))
ggsave(filename = here("Analyses/CPTAC/Output/full_plot_tprfdp_4labs.pdf"), 
       plot = full_plot_tprfdp, device = "pdf", dpi = 500, units = "mm", width = 180, height = 215)

ggsave(filename = here("Figures/full_plot_tprfdp_4labs.pdf"), 
       plot = full_plot_tprfdp, device = "pdf", dpi = 500, units = "mm", width = 180, height = 215)


```

```{r}

excel_supp_fig_39 <- bind_rows(
  lapply(names(tprFdpPlots), function(n) {
    df <- tprFdpPlots[[i]]$data[ , c("tpr", "fdp", "method")] %>% 
      as.data.frame() %>% 
      mutate("Comparison" = n)
  })
)

library(openxlsx)

file_path <- here("Figures/Source_Data.xlsx")

# Load existing workbook
wb <- loadWorkbook(file_path)

# Add new worksheet
addWorksheet(wb, "Supp_fig_39")

# Write data
writeData(wb, "Supp_fig_39", excel_supp_fig_39)

# Save
saveWorkbook(wb, file_path, overwrite = TRUE)
```

# Figures log-FC

```{r}
# Define the true logFC for the UPS proteins between the different conditions, which are
# known in advance. The Yeast proteins have a true logFC of 0.

y_intercepts <- data.frame(yintercept = c(log2(c(
    c(0.74, 2.22, 6.67, 20) / c(0.25), 
    c(2.22, 6.67, 20) / c(0.74), 
    c(6.67, 20) / c(2.22),
    20/6.67)), rep(0, 10)),
    "ups" = rep(c("Human spike-in", "Yeast"), each = 10))


# Make the logFC plots for spike-in UPS and non differential Yeast proteins for
# comparison i.

logFC_plots <- list()
for (i in comparisons_loop)
{

    # Extract the estimated logFCs by the msqrob2 model.
  
    logFC <- data.frame(
        GMF = rowData(pe_sgd[["msqrobAggregate"]])[[i]][, 1],
    DAE = rowData(pe_DAE[["msqrobAggregate"]])[[i]][, 1],
    VAE = rowData(pe_VAE[["msqrobAggregate"]])[[i]][, 1],
    CF = rowData(pe_CF[["msqrobAggregate"]])[[i]][, 1],
    KNN = rowData(pe_knn[["msqrobAggregate"]])[[i]][, 1],
    original = rowData(pe_original[["msqrobAggregate"]])[[i]][, 1],
    ups = rowData(pe_sgd[["msqrobAggregate"]])$ups)
    
    logFC <- logFC %>% gather(method, log2FC, c("GMF", 
                                            "DAE", "VAE", "CF", "KNN", "original"))
    logFC$ups <- factor(logFC$ups, labels = c("Yeast", "Human spike-in"))
logFC$method <- factor(logFC$method, levels = c("GMF", 
                                                "DAE", "VAE", "CF", "KNN", "original"),
                       labels = c("GMF", 
                                                "DAE", "VAE", "CF", "KNN", "no imputation"))

logFC_plots[[i]] <- logFC %>% ggplot(aes(x = method, y = log2FC, col = method)) +
    geom_boxplot() +
    geom_hline(data = y_intercepts[comparisons_loop == i,], aes(yintercept = yintercept), color = "grey30",
               linetype = "solid", alpha =0.5) + 
    ggtitle(plot_titles[comparisons_loop == i]) + 
    theme_bw() + 
    theme(legend.position = "none", axis.title.x = element_blank(), axis.text.x = element_blank(),
          axis.title.y = element_text(size = 7), axis.text = element_text(size = 6), plot.title = element_text(size=10),
          strip.text.x = element_text(size = 6))  +    
    scale_fill_discrete(name = "Protein", labels = c("Yeast", "Human spike-in")) +
    scale_x_discrete(labels = function(x) gsub("no imputation", "no \nimputation", x)) + 
  facet_wrap(~ups)  +
   colScale

}
legend_lfc <- ggpubr::get_legend(logFC %>% ggplot(aes(x = method, y = log2FC, col = method)) +
    geom_boxplot() +
    geom_hline(data = y_intercepts[comparisons_loop == i,], aes(yintercept = yintercept), color = "grey30") + 
    ggtitle(plot_titles[comparisons_loop == i]) + 
    theme_bw() + 
    theme(legend.position = "bottom", legend.title = element_text(size = 7), 
                                             legend.text = element_text(size = 6), legend.justification = "left", 
                                           legend.box.margin =  margin(l = 1.5, r = -2, unit = "cm")) +    
scale_fill_discrete(name = "Protein", labels = c("Yeast", "Human spike-in")) +
    scale_x_discrete(labels = function(x) gsub("no imputation", "no \nimputation", x)) + 
  facet_wrap(~ups)  +
  colScale)





```


```{r}
full_plot_lfc <- gridExtra::grid.arrange(grobs = append(logFC_plots,
                                    list(ggpubr::as_ggplot(legend_lfc))),
                        layout_matrix = rbind(c(1:4), c(5:8), c(9:10,11,11)))

saveRDS(object = append(logFC_plots,
                                    list(ggpubr::as_ggplot(legend_lfc))),
        file = here("Analyses/CPTAC/Output/logfcplots_4labs.RDS"))
ggsave(filename = here("Analyses/CPTAC/Output/full_plot_lfc_4labs.pdf"), 
       plot = full_plot_lfc, device = "pdf", dpi = 500, units = "mm", width = 180, height = 215)
ggsave(filename = here("Figures/full_plot_lfc_4labs.pdf"), plot = full_plot_lfc,
       device = "pdf", dpi = 500, units = "mm", width = 180, height = 215)

```


```{r}

excel_supp_fig_40 <- bind_rows(
  lapply(names(logFC_plots), function(n) {
    df <- logFC_plots[[i]]$data %>% 
      as.data.frame() %>% 
      mutate("Comparison" = n)
  })
)



# Add new worksheet
addWorksheet(wb, "Supp_fig_40")

# Write data
writeData(wb, "Supp_fig_40", excel_supp_fig_40)

# Save
saveWorkbook(wb, file_path, overwrite = TRUE)
```
